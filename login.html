<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login Absensi</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="shortcut icon" href="logo-kominfo.png" />
  </head>
  <body>
    <div class="form-container">
      <img
        src="logo-kominfo.png"
        alt="Logo BPSDMP KOMINFO"
        class="profile-pic"
      />

      <h2 class="judul">LOGIN ABSENSI PEGAWAI</h2>
      <h3 class="title">BPSDMP KOMINFO MANADO</h3>

      <form id="login-form">
        <label for="nama">Nama:</label>
        <select id="nama" required>
          <option value="">-- Pilih Nama --</option>
        </select>
        <br /><br />

        <button type="submit">Login</button>
      </form>
    </div>

    <script>
      // URL Web App Google Apps Script (sama dengan index.html)
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbxCqPJOG5OpeHnm8l_ypX-7nwu20jK_g-e0hz-k2Q7IzcL4wu5PnRjgO4jmy6y7NN_C/exec";

      // Ambil daftar nama dari Sheet2
      fetch(`${scriptURL}?action=getNames`)
        .then((res) => res.json())
        .then((data) => {
          const namaSelect = document.getElementById("nama");
          data.forEach((nama) => {
            const opt = document.createElement("option");
            opt.value = nama;
            opt.textContent = nama;
            namaSelect.appendChild(opt);
          });
        })
        .catch((err) => {
          console.error("Gagal ambil nama:", err);
          alert("Gagal memuat daftar nama, coba refresh halaman.");
        });

      // ‚úÖ Validasi lokasi wajib aktif
      let lokasiAktif = false;
      let userLat = null;
      let userLng = null;

      function cekLokasi() {
        if (!navigator.geolocation) {
          alert(
            "Browser Anda tidak mendukung GPS, silakan gunakan perangkat lain."
          );
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            lokasiAktif = true;
            userLat = pos.coords.latitude;
            userLng = pos.coords.longitude;
          },
          (err) => {
            lokasiAktif = false;
            alert("‚ö†Ô∏è Anda harus menyalakan lokasi (GPS) untuk login!");
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      }

      // jalankan cek lokasi saat halaman dibuka
      cekLokasi();

      // Proses login
      document.getElementById("login-form").addEventListener("submit", (e) => {
        e.preventDefault();
        const nama = document.getElementById("nama").value;

        // üö´ Jika lokasi belum aktif ‚Üí hentikan login
        if (!lokasiAktif || !userLat || !userLng) {
          alert("‚ö†Ô∏è Tidak bisa login, aktifkan lokasi (GPS) perangkat Anda!");
          return;
        }

        if (nama) {
          sessionStorage.setItem("loginNama", nama);
          // opsional: simpan koordinat ke sessionStorage juga
          sessionStorage.setItem("loginLat", userLat);
          sessionStorage.setItem("loginLng", userLng);

          window.location.href = "index.html"; // pindah ke form absensi
        } else {
          alert("Silakan pilih nama terlebih dahulu!");
        }
      });
    </script>
  </body>
</html>
